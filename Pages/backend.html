<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factory Physics - Technical Documentation</title>
    <!-- Link to your existing stylesheet -->
    <link rel="stylesheet" href="../style.css">

    <!-- MathJax for rendering LaTeX equations -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        /* Allows body to scroll on this standalone page */
        body {
            overflow-y: auto;
            overflow-x: hidden;
            /* Prevent horizontal scroll */
        }

        /* Style for documentation page layout */
        .documentation-container {
            max-width: 960px;
            /* Or adjust as needed */
            margin: 2rem auto;
            padding: 1rem;
            font-size: clamp(0.8rem, 1.5vw, 1rem);
            /* Use clamp for responsive base font */
            line-height: 1.6;
        }

        .documentation-container h2 {
            font-size: clamp(1.3rem, 2.5vw, 1.6rem);
            /* Responsive H2 */
            color: var(--header-bg);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--accent-color);
        }

        .documentation-container h3 {
            font-size: clamp(1rem, 2vw, 1.2rem);
            /* Responsive H3 */
            color: var(--header-bg);
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .documentation-container h4 {
            font-size: clamp(0.9rem, 1.8vw, 1.1rem);
            /* Responsive H4 */
            color: var(--accent);
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .documentation-container p {
            margin-bottom: 1rem;
        }

        .documentation-container ul,
        .documentation-container ol {
            margin-bottom: 1rem;
            padding-left: 2rem;
        }

        .documentation-container li {
            margin-bottom: 0.5rem;
        }

        /* Updated style for tooltip keywords */
        .documentation-container strong[data-tooltip] {
            cursor: help;
            border-bottom: 1px dotted var(--secondary2);
            /* Use color for underline */
            color: var(--secondary2);
            /* Use color for text */
            font-weight: 600;
            /* Slightly bolder */
        }

        /* Style for inline code snippets */
        code {
            background-color: var(--idle-color, #e5e7e9);
            color: var(--accent, #37474F);
            padding: 0.2em 0.4em;
            margin: 0;
            font-size: 90%;
            border-radius: 6px;
            font-family: monospace;
        }

        /* Styling for centered equations - prevent scrollbars */
        mjx-container[display="true"] {
            margin: 1.5em auto;
            /* Center horizontally */
            overflow-x: visible;
            /* Prevent scrollbar, allow natural overflow if needed */
            display: block;
            /* Ensure block display for centering */
            max-width: 100%;
            /* Prevent overflow */
            text-align: center;
            /* Center content within */
        }

        /* Ensure MathJax SVG output scales correctly */
        mjx-container svg {
            max-width: 100%;
            display: block;
            margin: 0 auto;
        }

        /* Table styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            font-size: clamp(0.75rem, 1.3vw, 0.9rem);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .data-table th,
        .data-table td {
            border: 1px solid #ddd;
            padding: 8px 10px;
            text-align: center;
            vertical-align: middle;
        }

        .data-table th {
            background-color: var(--accent);
            color: var(--white);
            font-weight: bold;
        }

        .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .data-table tr:hover {
            background-color: #f1f1f1;
        }

        .data-table td:nth-child(2) {
            /* Description column */
            text-align: left;
        }

        /* SVG Diagram Styles */
        .trailer-diagram {
            width: 100%;
            max-width: 600px;
            margin: 1rem auto;
            display: block;
            /* Background color moved to the trailer rect fill */
        }
    </style>
</head>

<body>

    <div class="documentation-container">

        <h2>Factory Physics: Website Backend Mechanics</h2>
        <p>
            This document details the formulas and algorithms used to calculate the backend mechanics of the factory
            physics simulation website. Hover over <strong
                data-tooltip="Key technical terms have tooltips like this!">highlighted key terms</strong> for
            definitions.
        </p>

        <h3>Global Constants & Constraints</h3>
        <p>
            These values are foundational to the simulation and cannot be changed by the user in the interface, ensuring
            consistency and computational feasibility:
        </p>
        <ul>
            <li>
                <strong>Build Ratios:</strong> The fixed production mix for the <strong
                    data-tooltip="An assembly line that produces multiple product variations sharing common steps.">
                    mixed assembly line</strong> is 35% Super, 45% Ultra, and 20% Mega. Fixing this prevents calculations from
                becoming too complex for a web browser.
            </li>
            <li>
                <strong>Precedence Data:</strong> The required order of assembly <strong
                    data-tooltip="Atomic tasks done by one person; cannot be shared or split.">elements</strong>
                is fixed, reflecting non-negotiable engineering and assembly logic based on the physical requirements 
                of building the refrigerators.  Order can be modified for elements so long as precedence is maintained.
            </li>
        </ul>

        <h4>Element Data Summary</h4>
        <p>
            The following table details the 31 assembly elements, their individual times, precedence requirements, and
            which refrigerator model requires them (1 = Yes, 0 = No).
        </p>
        <div style="overflow-x:auto;">
            <!-- Wrapper for table responsiveness -->
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Element</th>
                        <th>Element Description</th>
                        <th>Element Time</th>
                        <th>Predecessor(s)</th>
                        <th>Super</th>
                        <th>Ultra</th>
                        <th>Mega</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1</td>
                        <td>Place frame on holder and secure</td>
                        <td>0.8</td>
                        <td>-</td>
                        <td>1</td>
                        <td>1</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>Install internal heat exchanging pipes (IHEPs)</td>
                        <td>1.5</td>
                        <td>1</td>
                        <td>1</td>
                        <td>1</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td>Install compressor motor/pump kit</td>
                        <td>1.0</td>
                        <td>1</td>
                        <td>1</td>
                        <td>1</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>4</td>
                        <td>Install compressor electrical kit</td>
                        <td>1.3</td>
                        <td>3</td>
                        <td>1</td>
                        <td>1</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>5</td>
                        <td>Connect IHEPs to compressor</td>
                        <td>0.5</td>
                        <td>2, 3</td>
                        <td>1</td>
                        <td>1</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>6</td>
                        <td>Install defrost heater kit</td>
                        <td>0.7</td>
                        <td>1</td>
                        <td>1</td>
                        <td>1</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>7</td>
                        <td>Install defrost drain tube</td>
                        <td>0.7</td>
                        <td>6</td>
                        <td>1</td>
                        <td>1</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>8</td>
                        <td>Install water filter kit</td>
                        <td>0.8</td>
                        <td>1</td>
                        <td>0</td>
                        <td>1</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>9</td>
                        <td>Connect and route water pipes</td>
                        <td>0.5</td>
                        <td>8</td>
                        <td>0</td>
                        <td>1</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>10</td>
                        <td>Install basic electronic control board</td>
                        <td>1.2</td>
                        <td>1</td>
                        <td>1</td>
                        <td>1</td>
                        <td>0</td>
                    </tr>
                    <tr>
                        <td>11</td>
                        <td>Install advanced electronic control board</td>
                        <td>1.5</td>
                        <td>1</td>
                        <td>0</td>
                        <td>0</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>12</td>
                        <td>Connect and route electrical wires</td>
                        <td>2.0</td>
                        <td>10, 11</td>
                        <td>1</td>
                        <td>1</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>13</td>
                        <td>Install internal panels</td>
                        <td>2.5</td>
                        <td>4, 5, 7, 9, 12</td>
                        <td>1</td>
                        <td>1</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>14</td>
                        <td>Install evaporator and evaporator fans</td>
                        <td>1.5</td>
                        <td>13</td>
                        <td>1</td>
                        <td>1</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>15</td>
                        <td>Install external panels</td>
                        <td>2.2</td>
                        <td>14</td>
                        <td>1</td>
                        <td>1</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>16</td>
                        <td>Install external heat exchanging pipes (EHEPs)</td>
                        <td>1.2</td>
                        <td>15</td>
                        <td>1</td>
                        <td>1</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>17</td>
                        <td>Connect EHEPs to compressor</td>
                        <td>0.5</td>
                        <td>16</td>
                        <td>1</td>
                        <td>1</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>18</td>
                        <td>Install door brackets</td>
                        <td>0.8</td>
                        <td>14</td>
                        <td>1</td>
                        <td>1</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>19</td>
                        <td>Install freezer compartment door</td>
                        <td>1.1</td>
                        <td>18</td>
                        <td>1</td>
                        <td>1</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>20</td>
                        <td>Install icemaker kit into freezer door</td>
                        <td>0.5</td>
                        <td>19</td>
                        <td>0</td>
                        <td>1</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>21</td>
                        <td>Connect pre-routed water pipes to icemaker</td>
                        <td>0.5</td>
                        <td>20</td>
                        <td>0</td>
                        <td>1</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>22</td>
                        <td>Install refrigerator compartment door</td>
                        <td>1.3</td>
                        <td>18</td>
                        <td>1</td>
                        <td>1</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>23</td>
                        <td>Install touchscreen (TS) into refrigerator door</td>
                        <td>0.7</td>
                        <td>22</td>
                        <td>0</td>
                        <td>0</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>24</td>
                        <td>Connect pre-routed electrical wires to TS</td>
                        <td>0.9</td>
                        <td>23</td>
                        <td>0</td>
                        <td>1</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>25</td>
                        <td>Install sensors and switches</td>
                        <td>1.3</td>
                        <td>19, 22</td>
                        <td>1</td>
                        <td>1</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>26</td>
                        <td>Install lighting kit</td>
                        <td>1.0</td>
                        <td>19, 22</td>
                        <td>1</td>
                        <td>1</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>27</td>
                        <td>Connect remaining pre-routed electrical wires</td>
                        <td>0.7</td>
                        <td>25, 26</td>
                        <td>1</td>
                        <td>1</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>28</td>
                        <td>Assemble internal shelves and drawers</td>
                        <td>1.0</td>
                        <td>27</td>
                        <td>1</td>
                        <td>1</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>29</td>
                        <td>Install feet and wheels</td>
                        <td>0.7</td>
                        <td>15</td>
                        <td>1</td>
                        <td>1</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>30</td>
                        <td>Visual and structural inspection</td>
                        <td>0.5</td>
                        <td>17, 21, 24, 27, 29</td>
                        <td>1</td>
                        <td>1</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>31</td>
                        <td>Remove from holder and package</td>
                        <td>0.4</td>
                        <td>30, 28</td>
                        <td>1</td>
                        <td>1</td>
                        <td>1</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <ul>
            <li>
                <strong>Assembly Line Length:</strong> Fixed at 486 feet. This length is predicated on
                providing adequate physical <strong data-tooltip="Physical area required for an operation.">
                    floor space</strong> (6 feet) for the task with the shortest element time (0.4 minutes), ensuring no task
                is physically constrained.
                \[\left( \frac{\text{Total Element Time (32.4 min)}}{0.4 \text{ min/element}} \right) \times 6 \text{
                feet/element} = 486 \text{ feet}\]
            </li>
            <li>
                <strong>Workstation Capacities & Configurations:</strong> For each potential number of employees (<strong
                    data-tooltip="A designated area where a specific set of assembly tasks (elements) are performed, typically by one operator.">workstations</strong>)
                from 3 to 13, a near-optimal task assignment configuration is pre-defined. These configurations were generated using a custom algorithm, <strong
                    data-tooltip="Backpropagating Iterative Ranked Weights: Custom algorithm used to improve line balance by iteratively applying a reversed RPW method.">BIRW</strong>
                (Backpropagating Iterative Ranked Weights). This algorithm refines an initial assignment from the standard <strong
                    data-tooltip="Ranked Positional Weights: Algorithm for assigning tasks to workstations based on task time and precedence constraints, often resulting in front-loaded imbalance.">RPW</strong>
                (Ranked Positional Weights) method. RPW tends to front-load tasks, leading to imbalance. BIRW addresses this by:
                <ol>
                    <li>
                        Running RPW forward to get a baseline number of stations and average
                        station time.
                    </li>
                    <li>Calculating the standard deviation of individual element times.</li>
                    <li>
                        Iteratively running a *reversed* RPW (processing tasks from last to first, using successors
                        instead of predecessors) with varying workstation time capacities.
                    </li>
                    <li>
                        Selecting the configuration from these iterations that yielded the lowest variance in
                        workstation idle times.
                    </li>
                </ol>
                Associated with these BIRW-optimized configurations are pre-calculated maximum daily demand capacities:
                <code>
                    <pre>
[
 { ws: 3, maxDemand: 147 }, { ws: 4, maxDemand: 192 }, { ws: 5, maxDemand: 229 },
 { ws: 6, maxDemand: 284 }, { ws: 7, maxDemand: 312 }, { ws: 8, maxDemand: 350 },
 { ws: 9, maxDemand: 407 }, { ws: 10, maxDemand: 419 }, { ws: 11, maxDemand: 499 },
 { ws: 12, maxDemand: 501 }, { ws: 13, maxDemand: 552 }
]
                </pre>
                </code>These capacities significantly speed up the profit optimization by eliminating impossible scenarios early.
            </li>
        </ul>

        <h3>Core Operational Calculations</h3>
        <p>
            This central function translates user inputs (Demand, Op Hours, Employees, Costs/Prices) into the primary
            operational and financial KPIs displayed in the UI.
        </p>

        <h4>1. Workstation Details & Bottleneck Identification</h4>
        <p>
            The function first determines, for the selected number of employees:
        </p>
        <ul>
            <li>
                <strong>
                    Station <strong
                        data-tooltip="The actual time it takes for one unit to be completed at the slowest workstation. This determines your line's true output rate.">
                        Cycle Time</strong> (min):</strong> Calculated for each workstation by summing the <strong
                    data-tooltip="The average time an operator spends on a task per unit, considering the mix of models being built and task requirements.">
                    labor time</strong> of all tasks assigned to it. This represents the average
                workload per unit for that station.
            </li>
            <li>
                <strong>
                    Line <strong
                        data-tooltip="The single process or workstation that limits the overall output rate of the entire system.">Bottleneck</strong>Time (min):
                </strong> The maximum Station Cycle Time found across all workstations. This value
                dictates the absolute fastest rate the entire line can produce units.
            </li>
            <li>
                <strong>Fastest Station Time (min):</strong> The minimum non-zero Station Cycle Time. Used to calculate
                product spacing.
            </li>
        </ul>
        <p>
            Labor Time (average work content) determines the bottleneck and cycle time, while Element Time (discrete task duration) influences physical layout and travel times.
        </p>

        <h4>2. Conveyor Speed & Spacing (Physical Parameters)</h4>
        <p>
            These are calculated to ensure smooth <strong
                data-tooltip="The movement of materials and products through the production process.">flow</strong> and
            prevent starving the fastest workstation of work:
        </p>
        <ul>
            <li>
                <strong>Product Spacing (ft):</strong> Fixed based on the fastest station's labor time and a maximum
                theoretical conveyor speed of 15 ft/min (chosen for reasonable work pace). Displayed in the UI.
                \[\text{Product Spacing} = \text{Fastest Labor Time} \times 15 \text{ ft/min}\]
            </li>
            <li>
                <strong>Actual Conveyor Speed (ft/min):</strong> The calculated speed the conveyor must run at based on
                the fixed spacing and the line's actual operating pace (Effective Cycle Time). Displayed in the UI.
                \[\text{Conveyor Speed} = \frac{\text{Product Spacing}}{\text{Effective Cycle Time}}\]
            </li>
        </ul>

        <h4>
            3. Required <strong
                data-tooltip="The required pace (time per unit) of production needed to meet customer demand within the available operating time.">
                Takt Time</strong> Calculation
        </h4>
        <p>
            This determines the pace (minutes per unit) required to meet the user-set Daily Demand within
            the specified Operational Hours. The formula correctly accounts for the initial time needed to fill the
            entire assembly line before the first unit is completed:
        </p>
        \[ \text{Required Takt Time} = \frac{\text{Total Operational Minutes}}{(\text{Daily Demand} - 1) +
        (\frac{\text{Assembly Line Length}}{\text{Product Spacing}})} \]
        <p>(Note: Takt Time becomes infinite if Daily Demand ≤ 1).</p>

        <h4>4. Effective Cycle Time</h4>
        <p>
            This is the actual time between units completing, representing the true pace the line will run at. It's
            limited by either the demand requirement or the line's physical capability:
        </p>
        \[\text{Effective Cycle Time} = \max(\text{Required Takt Time, Bottleneck Time})\]

        <h4>
            5. <strong
                data-tooltip="The number of units completed per unit of time (e.g., per hour or per day).">Throughput</strong>
            & <strong
                data-tooltip="Work In Progress: The average number of incomplete products currently physically present on the assembly line.">WIP</strong>
            Calculation (User-Visible KPIs)
        </h4>
        <ul>
            <li>
                <strong>
                    Actual <strong data-tooltip="The total time it takes for a single unit to travel from the start to the end of the assembly line.">Process Time</strong> (min):
                </strong> The total time for one unit to traverse the entire line at the effective pace:
                \[\text{Actual Process Time} = \frac{\text{Assembly Line Length}}{\text{Product Spacing}} \times
                \text{Effective Cycle Time}\]
            </li>
            <li>
                <strong>
                    <strong
                        data-tooltip="The number of units completed per unit of time (e.g., per hour or per day).">Throughput</strong>(Units per Day):
                </strong> The total number of units the line can actually produce within the
                operating hours. Calculated based on the "launch window" (total time minus the time for the first unit
                to exit):
                \[\text{Throughput}_{\text{Units/Day}} = \left\lfloor \frac{\text{Total Op Minutes} - \text{Actual Process Time}}{\text{Effective Cycle Time}} \right\rfloor + 1\]
                (Throughput is 0 if Total Op Minutes < Actual Process Time). </li>
            <li>
                <strong>
                    <strong
                        data-tooltip="The number of units completed per unit of time (e.g., per hour or per day).">Throughput</strong>(Units per Hour):
                </strong> Calculated for display in the UI based on the actual production achieved
                over the *effective* production time (which might be less than opHours if demand is low).
            </li>
            <li>
                <strong>
                    <strong
                        data-tooltip="Work In Progress: The average number of incomplete products currently physically present on the assembly line.">WIP</strong>(Units):
                </strong> The average number of units physically on the line at any given time. Displayed in
                the UI.
                \[\text{WIP} = \frac{\text{Assembly Line Length}}{\text{Product Spacing}}\]
            </li>
        </ul>

        <h3>Efficiency and Balance Metrics (User-Visible KPIs)</h3>
        <ul>
            <li>
                <strong>
                    Average <strong
                        data-tooltip="Percentage of total available operator time that is spent productively working on units.">Efficiency</strong>(%):
                </strong> Overall measure of labor utilization. Displayed in the UI.
                \[\text{Avg. Efficiency} = \frac{\text{Throughput}_{\text{Units/Day}} \times \sum \text{Task Labor Times}}{\text{Num Employees} \times \text{Total Op Minutes}} \times 100\%\]
            </li>
            <li>
                <strong>Total Idle Time (hrs):</strong> Total non-productive paid labor time across all employees per
                day. Displayed in the UI.
                \[ \text{Total Idle Time} = (\text{Num Employees} \times \text{Total Op Minutes}) -
                (\text{Throughput}_{\text{Units/Day}} \times \sum \text{Task Labor Times}) \]
            </li>
            <li>
                <strong
                    data-tooltip="The percentage of time operators are idle specifically due to unequal workload distribution between workstations.">Balance
                    Delay</strong> (%): Measures inefficiency specifically from unequal task distribution. Displayed in the UI.
                <ol type="a" style="padding-left: 1.5rem; margin-top: 0.5rem;">
                    <li>
                        Workstation Efficiency = \( \frac{\text{Workstation Cycle Time}}{\text{Bottleneck Cycle Time}}
                        \times 100\% \)
                    </li>
                    <li>Balance Delay = \( 100\% - \text{Average}(\text{All Workstation Efficiencies}) \)</li>
                </ol>
            </li>
            <li>
                <strong
                    data-tooltip="The Coefficient of Variation (standard deviation / mean) of idle times across workstations. Measures how *evenly* the idle time (imbalance) is distributed. Lower is better.">
                    Idle Time CV (BD CV)</strong> (%): Quantifies the *variation* in idle time between stations. A high CV
                means some stations are very busy while others are very idle, even if the average Balance Delay isn't
                terrible. Displayed in the UI.
                \[ \text{Idle Time CV} = \left( \frac{\text{StdDev}(\text{Station Idle Times per Cycle})}{\text{Mean}(\text{Station Idle Times per Cycle})} \right) \times 100\% \]
                (Where Station Idle Time per Cycle = Bottleneck Time - Station Cycle Time).
            </li>
        </ul>

        <h3>Integrated Financial Model (Daily KPIs)</h3>
        <p>
            Connects the calculated operational throughput to daily financial performance shown in the UI:
        </p>
        <ul>
            <li>
                <code>Total Revenue</code> = Throughput × Weighted Avg. Selling Price (per model price ×
                <code>Build Ratios</code>)
            </li>
            <li>
                <strong
                    data-tooltip="Cost Of Goods Sold: Variable costs (materials, direct labor) associated directly with producing goods."><code>Total COGS</code></strong>
                = Throughput × Weighted Avg. COGS (per model COGS × <code>Build Ratios</code>)
            </li>
            <li><code>Total Daily Labor Cost</code> = Num Employees × Op Hours × Labor Rate</li>
            <li>
                <strong
                    data-tooltip="Revenue minus COGS and direct Labor Cost. Profit generated directly from production before overheads."><code>Daily Gross Profit</code></strong>
                ($): Displayed in the UI (Rework under CoPQ below).
                \[ \text{Gross Profit} = \text{Revenue} - \text{COGS} - \text{Labor Cost} - \text{Rework Cost} \]
            </li>
            <li>
                <strong
                    data-tooltip="Gross Profit expressed as a percentage of total revenue. Measures profitability of production itself."><code>Gross Profit Margin</code></strong>
                (%): Displayed in the UI.
                \[ \text{Gross Profit Margin} = \left( \frac{\text{Gross Profit}}{\text{Revenue}} \right) \times 100\%\]
            </li>
        </ul>
        <h3>Profit Maximization Algorithm</h3>
        <p>
            Used by the Profit Tab to find the optimal configuration (employees & hours) for each demand level (50-552).
            It uses a grid search optimized by:
        </p>
        <ol>
            <li>
                <strong>Capacity Pruning:</strong> Uses predetermined capacity thresholds to skip employee counts that
                cannot possibly meet the target demand.
            </li>
            <li>
                <strong>Early Exit:</strong> For a fixed demand and employee count, it calculates the minimum required
                Operational Hours. It then iterates hours upwards in 0.25 increments. The *first* hour value that
                achieves <code>Throughput >= Demand</code> is guaranteed to be the most profitable (lowest cost) for
                that combination, so the inner loop breaks immediately.
            </li>
        </ol>

        <h3>
            Model-Mix Sequencing (MSSA / <strong
                data-tooltip="A lean manufacturing method (also called Heijunka) for leveling production by sequencing different product models in a repeating pattern to smooth demand on components and workload.">Heijunka</strong>)
        </h3>
        <p>Used by the Layout and Schedule tabs to create a balanced production sequence for simulations:</p>
        <ol>
            <li>
                <strong>Calculate Interval (\(w\)):</strong> Average production frequency per model: \(w_{\text{model}}
                = \frac{\text{Total Demand}}{\text{Model Demand}}\).
            </li>
            <li>
                <strong>Initialize Accumulator (\(a\)):</strong> Each model starts at \(a = w/2\) (ensures highest
                frequency model goes first).
            </li>
            <li>
                <strong>Iterate & Select:</strong> For each unit in the total demand, select the model with the
                currently lowest \(a\) value (the one most "behind schedule").
            </li>
            <li>
                <strong>Update Accumulator:</strong> Add the full interval \(w\) to the selected model's accumulator:
                \(a \leftarrow a + w\).
            </li>
        </ol>

        <h3>Discrete-Event Simulation for Gantt Scheduling</h3>
        <p>Models product flow through each task for the Schedule Tab visualization:</p>
        <ul>
            <li>
                <strong>Station Travel Time:</strong> Calculates how long a product takes to physically move across a
                station's length on the conveyor. It's proportional to the station's share of the total line's Element Time:
                \[\text{Travel Time}_{\text{station}} = \left( \frac{\sum \text{Element Time}_{\text{station}}}{\sum
                \text{Element Time}_{\text{line}}} \right) \times \left( \frac{\text{Line Length}}{\text{Conveyor Speed}} \right)\]
            </li>
            <li>
                <strong>Task Start Time:</strong> Accurately models waiting scenarios (product waiting for worker, or
                worker waiting for product):
                \[\text{Start Time} = \max(\text{Product Arrival Time}, \text{Worker Free Time})\]
            </li>
            <li>
                <strong>Product Exit Time from Station:</strong> Accounts for both processing completion and travel time: 
                \[\text{Start Time} = \max(\text{End Processing Time}, \text{Product Arrival Time + Station Travel Time})\]
            </li>
        </ul>

        <h3>Capital Investment Analysis (Investment Tab)</h3>
        <p>
            Evaluates long-term investment viability over the selected Analysis Period, default of 5 years.
        </p>

        <h4>
            <strong
                data-tooltip="Cash generated by a company's operations after accounting for capital expenditures needed to maintain operations.">
                Free Cash Flow (FCF)</strong> Calculation
        </h4>
        <p>
            FCF is the basis for investment metrics. For each year (\(t\)) from 1 to \(n\) (analysis period), it's
            calculated as:
        </p>
        <ol type="a">
            <li>
                Calculate Earnings Before Interest and Taxes:
                \[ \text{EBIT}_t = \text{Revenue}_t - \text{COGS}_t - \text{Labor}_t - \text{Overheads}_t -
                \text{Depreciation}_t \]
            </li>
            <li>
                Calculate <strong
                    data-tooltip="Net Operating Profit After Tax. A measure of profitability that excludes debt financing effects.">
                    Net Operating Profit After Tax (NOPAT)</strong>: \[ \text{NOPAT}_t = \text{EBIT}_t \times (1 - \text{Tax Rate}) \]
            </li>
            <li>
                Calculate <strong
                    data-tooltip="Cash generated by a company's operations after accounting for capital expenditures needed to maintain operations.">
                    Free Cash Flow (FCF)</strong>: \[ \text{FCF}_t = \text{NOPAT}_t + \text{Depreciation}_t \]
                (Depreciation is calculated using the selected <strong
                    data-tooltip="Modified Accelerated Cost Recovery System. A US tax depreciation system specifying depreciation rates per year.">MACRS</strong>
                schedule. In the final year \(n\), the after-tax Salvage Value is added: \( \text{FCF}_n \leftarrow
                \text{FCF}_n + \text{Salvage Value} \times (1 - \text{Tax Rate}) \)). The Year 0 FCF is the negative
                Initial Investment.
            </li>
        </ol>

        <h4>Investment Metrics</h4>
        <p>The FCF series (\(FCF_0, FCF_1, ..., FCF_n\)) is used to compute:</p>
        <ul>
            <li>
                <strong
                    data-tooltip="A project's total discounted future cash flows minus the initial investment. If positive, the project is expected to generate more value than its cost.">
                    Net Present Value (NPV)</strong>: Discounts future FCFs back to present value using the <strong
                    data-tooltip="Minimum Acceptable Rate of Return: The hurdle rate or required return an investor expects for undertaking the risk of an investment.">MARR</strong>.
                A positive NPV suggests a potentially acceptable investment.
                \[NPV = \sum_{t=0}^{n} \frac{FCF_t}{(1 + MARR)^t}\]
            </li>
            <li>
                <strong
                    data-tooltip="The discount rate (%) at which a project's Net Present Value (NPV) equals zero. Represents the project's effective rate of return. Higher is better.">
                    Internal Rate of Return (IRR)</strong> (%): The effective rate of return of the investment. It's the discount
                rate (\(r\)) where NPV = 0. Calculated numerically using the bisection method (iteratively narrowing a
                rate range [low, high] until the NPV at the midpoint is close to zero).
            </li>
            <li>
                <strong
                    data-tooltip="The time (in years or days) required for an investment's cumulative positive cash inflows to equal the initial investment cost.">
                    Payback Period</strong> (Years/Days): Time until cumulative positive FCFs (\( \sum_{t=1}^{k} FCF_t \))
                recover the initial investment (\( |FCF_0| \)). If payback occurs between year \(k-1\) and year \(k\):
                \[ \text{Payback Period} = (k-1) + \frac{|FCF_0| - \sum_{t=1}^{k-1} FCF_t}{FCF_k} \]
                (Result is Infinity if investment is never recovered). Calculated in days for UI display.
            </li>
        </ul>
        <ul>
            <li>
                <strong>Base Case Analysis:</strong> This mode evaluates the investment using the
                operational parameters currently selected in the main interface (i.e., the number of employees and daily
                operating hours). It first calculates the line's maximum annual production capacity under these fixed
                settings. If a projected annual demand exceeds this capacity, the financial model correctly caps
                production at the maximum achievable level. This provides a realistic financial forecast for the line as
                it is currently configured, reflecting a capacity-constrained scenario.
            </li>
            <li>
                <strong>Expansion Case Analysis:</strong> This mode performs a dynamic optimization to
                find the ideal operational setup for a given demand. For a specified annual demand, this algorithm systematically 
                searches all feasible combinations of employee counts (from 3 to 13) and the minimum required operating hours for
                each. It calculates the full cash flow series and resulting NPV for each potential configuration,
                ultimately identifying and using the specific operational setup that maximizes the project's Net Present
                Value. This ensures the financial analysis is based on the most profitable way to meet the target
                demand, rather than being limited by the current settings.

            </li>
        </ul>

        <p>
            For either case, the following multi-step process is used to generate the annual cash flow:
        </p>
        <ol style="list-style-type: decimal; padding-left: 1.5rem;">
            <li>
                <strong>Initial Investment Calculation:</strong> The model first determines the initial
                capital outlay, which is directly tied to the number of employees. The total equipment cost is
                calculated from the cost of the straight conveyor sections plus a variable cost for the number of 
                90-degree bends, which is a function of the employee count (e.g., <code>(4 * Employees) - 2</code> for an 
                even number of workers). In an Expansion Case, this model also compares the cost of the "old" line
                (based on current employees) to the "new" line (based on the optimal employee count). If the new line is
                smaller, a partial salvage value is credited against the initial investment, calculated as a proportion
                of the total Salvage Value based on the reduction in cost. Conversely, if the new line is
                larger, the cost difference is added to the investment, reflecting the incremental capital required.
            </li>
            <li>
                <strong>Operating Costs and Overhead Scaling:</strong> The model calculates annual
                operating costs, including Total Material and Labor Costs (based on units produced). 
                A key feature is the dynamic scaling of overheads; both Mfg Overhead and SG&A Expenses
                are increased proportionally if the operating hours required for the scenario exceed the 
                base operating hours. This realistically models the increased wear, utility
                consumption, and administrative burden of running longer shifts.

            </li>
            <li>
                <strong>Free Cash Flow Generation:</strong> With all costs established, the function
                constructs a pro forma income statement for each year. It calculates revenue, subtracts all costs
                (material, labor, scaled overheads, <strong
                    data-tooltip="Total annual cost for transporting goods, derived from the Location Tab analysis.">freight</strong>),
                and also deducts the non-cash tax depreciation expense using the 5-year Modified Accelerated Cost Recovery System (<strong
                    data-tooltip="Modified Accelerated Cost Recovery System. A US tax depreciation system specifying depreciation rates per year.">MACRS</strong>)
                schedule. It then computes the <strong
                    data-tooltip="Net Operating Profit After Tax. A measure of profitability that excludes debt financing effects.">
                    Net Operating Profit After Tax (NOPAT)
                </strong> and correctly adds back the depreciation charge to
                arrive at the <strong
                    data-tooltip="Cash generated by a company's operations after accounting for capital expenditures needed to maintain operations.">
                    free
                    cash flow
                </strong> for each period—the appropriate input for the NPV and IRR analyses.
            </li>
        </ol>
        <h3>Probabilistic Demand Forecasting Model</h3>
        <p>
            To account for uncertainty in long-term planning, the investment analysis is enhanced with a
            probabilistic demand model. The user may define a probability distribution for annual demand rather than 
            relying on a single point estimate. This model is centered on the p50 annual demand (the mean or most likely 
            outcome, derived from the current operational inputs). The user can then specify the dispersion of the forecast 
            in one of three ways: by entering the standard deviation, the coefficient of variation, or by providing P10 (pessimistic) 
            and P90 (optimistic) forecasts. If a P10 or P90 value is provided, the code correctly uses the standard Z-score for a 90% 
            confidence interval (Z = 1.28155) to reverse-calculate the implied standard deviation.
        </p>
        <p>
            This enables a three-point estimation (optimistic, pessimistic, most likely). Each of these three demand scenarios are 
            then evaluated according to the user's selected mode (Base Case or Expansion Case). This provides a full range of potential 
            investment outcomes for each possible future, giving a much richer picture of the project's risk and reward profile.
        </p>

        <h3>Facility Location Optimization</h3>
        <p>
            Finds the optimal factory location to minimize total annual transportation costs, solving the <strong
                data-tooltip="A classic optimization problem to find a single point that minimizes the weighted sum of distances to a set of destination points.">
                Weber
                Problem
            </strong> using calculated annual shipping costs as weights.
        </p>

        <h4>Optimization Modes: New vs. Existing</h4>
        <ul>
            <li>
                <strong>New (Greenfield):</strong> Iteratively finds the best *coordinate* using the Weiszfeld
                algorithm, weighted by annual cost to each city:
                \[\text{New Coordinate} = \frac{\sum_{i} \frac{\text{City Coordinate}_i \times \text{Annual Cost}_i}{\text{Distance}_i}}{\sum_{i} \frac{\text{Annual Cost}_i}{\text{Distance}_i}}\]
                <p>
                    Upon determining an optimal median value, all existing locations are then checked to see if any have a lower cost.
                </p>
            </li>
            <li>
                <strong>Existing (Brownfield):</strong> Evaluates the total annual shipping cost if the factory were
                located *at each user-added city*, then selects the existing city with the minimum total cost.
            </li>
        </ul>

        <h4>Logistics Cost Model</h4>
        <ul>
            <li>
                <strong>Distances:</strong> Uses Great-Circle distance, calculated via the spherical law
                of cosines:
                \[ d = (3963.34-(13.35 \times \sin(\frac{|\phi1 - \phi2|}{2})) \times (\arccos(\sin(\phi_1)\sin(\phi_2)
                +
                \cos(\phi_1)\cos(\phi_2)\cos(\Delta\lambda))) \]
                <p style="margin-top:0.5rem; margin-bottom:0.5rem;">
                    Where \(\phi_1, \phi_2\) are the latitudes, and
                    \(\Delta\lambda\) is the difference in longitudes. This
                    distance is then adjusted by a Circuitry Factor (1.2 for > 250mi, 1.35 for < 250mi). Shipments under
                        10 miles are considered local with zero transport cost. </p>
            </li>
            <li>
                <strong>
                    <strong
                        data-tooltip="Full Truckload. Shipping method where an entire truck is dedicated to one shipment, typically cheaper per mile but requires a full load.">FTL</strong>
                    vs. <strong
                        data-tooltip="Less-Than-Truckload. Shipping method where multiple smaller shipments share space on the same truck, more flexible but typically more expensive per unit weight/distance.">LTL</strong>:
                </strong>
                Conceptually, FTL reserves a whole truck, offering a lower cost per mile. This rate is dynamic and based
                on the <strong
                    data-tooltip="A measure of the average change in selling prices received by domestic producers for their output.">
                    Producer
                    Price Index (PPI)
                </strong>:
                \[ \text{FTL Rate} = \frac{PPI \times \$2.00}{102.7} \]
                <p style="margin-top:0.5rem;">
                    LTL shares truck space, suitable for smaller quantities
                    but with a complex, higher cost. This model assumes trucks "cube out" (fill up space) at <strong>
                        60
                        units
                    </strong>, based on refrigerator dimensions and stacking constraints (**21 Super, 27 Ultra,
                    12 Mega**). The ratioed average weight per unit is assumed to be ~410 lbs. The model calculates the
                    number
                    of full 60-unit FTLs needed per shipment. For the remaining units (remainder), it compares the
                    calculated LTL cost vs. the cost of sending another FTL for just those units, then chooses the
                    minimum cost option for the remainder.
                </p>
            </li>
        </ul>

        <p style="margin-top:1rem;">This formula is dynamic and tied to economic conditions:</p>
        <ul style="margin-top:0.5rem; margin-bottom: 1rem;">
            <li>
                <strong>PPI / FTL Rate:</strong> The <strong
                    data-tooltip="A measure of the average change in selling prices received by domestic producers for their output.">
                    Producer
                    Price Index (PPI)
                </strong> links to the specific index for <a href="https://data.bls.gov/timeseries/PCU484121484121"
                    target="_blank" rel="noopener noreferrer">Industry Code 484121</a> (General Freight Trucking,
                Long-Distance,
                Truckload). This PPI value is used to calculate the <code>FTL Rate</code>, which anchors both FTL and
                LTL cost calculations to current market conditions. The <code>102.7</code> term is a baseline PPI value
                for a $2.00 normalization.
            </li>
            <li>
                <strong>Density Factor:</strong> A constant density factor of <code>0.19454</code> is derived from the
                formula:
                \[ \text{Density Factor} = \frac{\frac{s^2}{8} + 14}{s^2 + 2s + 14} \]
                <p style="margin-top:0.5rem; margin-bottom:0.5rem;">
                    Where \(s\) is the average packing
                    density (\( \approx 10.24 \text{ lbs/sq ft} \)) based on the below load plan.
                </p>
            </li>
        </ul>
        <p style="text-align:center; font-style:italic; margin-top:1rem;">
            Cross-section of 53' trailer
        </p>

        <svg class.="trailer-diagram" viewBox="0 0 550 150" preserveAspectRatio="xMidYMid meet"
            xmlns="http://www.w3.org/2000/svg">

            <rect x="10" y="10" width="530" height="100" rx="5" ry="5" fill="#e5e7e9" stroke="#37474f"
                stroke-width="4" />

            <g id="load-plan-content" transform="translate(2, 6)">

                <rect x="10" y="52" width="220" height="50" fill="#f3de8a" stroke="#37474f" stroke-width="1" />
                <text x="120" y="72" font-family="sans-serif" font-size="9" text-anchor="middle" fill="#333"
                    font-weight="bold">Ultra</text>
                <text x="120" y="84" font-family="sans-serif" font-size="9" text-anchor="middle" fill="#333">
                    (18
                    units, 22 ft)
                </text>

                <rect x="10" y="12" width="210" height="40" fill="#8ac9f3" stroke="#37474f" stroke-width="1" />
                <text x="115" y="30" font-family="sans-serif" font-size="9" text-anchor="middle" fill="#333"
                    font-weight="bold">Super</text>
                <text x="115" y="42" font-family="sans-serif" font-size="9" text-anchor="middle" fill="#333">
                    (21
                    units, 21 ft)
                </text>

                <rect x="232" y="42" width="180" height="60" fill="#e98f85" stroke="#37474f" stroke-width="1" />
                <text x="322" y="67" font-family="sans-serif" font-size="9" text-anchor="middle" fill="#333"
                    font-weight="bold">Mega</text>
                <text x="322" y="79" font-family="sans-serif" font-size="9" text-anchor="middle" fill="#333">
                    (12
                    units, 18 ft)
                </text>

                <rect x="414" y="52" width="110" height="50" fill="#f3de8a" stroke="#37474f" stroke-width="1" />
                <text x="469" y="72" font-family="sans-serif" font-size="9" text-anchor="middle" fill="#333"
                    font-weight="bold">Ultra</text>
                <text x="469" y="84" font-family="sans-serif" font-size="9" text-anchor="middle" fill="#333">
                    (9
                    units, 11 ft)
                </text>
            </g>

            <g id="hitching-area">
                <rect x="15" y="110" width="80" height="6" rx="2" ry="2" fill="#37474f" />
            </g>

            <g id="landing-gear">
                <rect x="60" y="115" width="10" height="30" fill="#555" />
                <rect x="80" y="115" width="10" height="30" fill="#555" />
                <rect x="55" y="140" width="40" height="5" fill="#555" />
            </g>

            <g id="wheel-assembly">
                <rect x="440" y="112" width="80" height="15" fill="#777" />
                <circle cx="460" cy="128" r="16" fill="#333" stroke="black" stroke-width="1" />
                <circle cx="500" cy="128" r="16" fill="#333" stroke="black" stroke-width="1" />
            </g>
        </svg>

        <p>
            <strong>LTL Cost Formula:</strong> A non-linear estimation based on the FTL Rate,
            packing density, weight (\(q\) in tons), and road distance (\(d\) in miles):
            \[\text{LTL Rate} = \frac{(\text{PPI} \times 0.19454) \cdot q \cdot d}{(q^{1/7}
            \cdot d^{15/29}) - 3.5}\]
        </p>
        <h4>Holding Cost Calculation</h4>
        <p>
            The <strong
                data-tooltip="Costs associated with storing inventory, including capital, storage, service, and risk costs.">
                inventory holding cost
            </strong> rate (%) displayed in the Location Tab is an estimated value derived from four
            primary components, as calculated below:
        </p>
        <ul>
            <li>
                <strong>Capital Cost (Opportunity Cost):</strong> This represents the return that could
                have been earned if the capital tied up in inventory were invested elsewhere. It's directly set by the
                <strong
                    data-tooltip="Minimum Acceptable Rate of Return: The hurdle rate or required return an investor expects for undertaking the risk of an investment.">MARR</strong>
                value from the Investment tab.
                \[ \text{Capital Cost} = \text{MARR} \]
            </li>
            <li>
                <strong>Service Costs:</strong> Includes insurance, taxes, and handling. This component
                is calculated based on the number of working days per year (affecting insurance/handling needs) and the
                corporate tax rate.
                \[ \text{Service Cost} = \text{5%} + (\text{5%} \times \frac{\text{Working Days}}{365}) + (10
                \times {\text{Tax Rate%}}) \]
            </li>
            <li>
                <strong>Storage Space Costs:</strong> Represents the cost of the physical space
                (warehouse rent, utilities). This cost is dynamically estimated based on the proximity to customers. It
                assumes that locations closer to dense customer areas (shorter minimum shipping distance) likely have
                higher real estate costs. A linear scale is used, ranging from 10% for locations very close (50 miles)
                to 4% for more remote locations (500+ miles).
                \[ \text{Storage Cost} = \text{Scale}(\min(\text{Distances to Cities})) \quad
                \text{[Scale: 50mi → 10%, 500mi → 4%]} \]
            </li>
            <li>
                <strong>Inventory Risk Costs:</strong> Covers obsolescence, damage, theft, and
                perishability. This is estimated based on the average shipment frequency to customers. More frequent
                shipments imply faster inventory turnover, reducing these risks. A power scale is used, ranging from 5%
                for very frequent shipments (e.g., weekly) up to 15% for less frequent shipments (e.g., bi-monthly).
                \[ \text{Risk Cost} = \text{Scale}(\text{Average}(\text{Shipment Frequencies})) \quad
                \text{[Scale: 7 days → 5%, 60 days → 15%]} \]
            </li>
        </ul>
        <p>The total estimated holding cost rate is the sum of these four components. This rate is then used in
            the daily inventory simulation.</p>

        <h4>Shipping Strategy & Simulation</h4>
        <p>
            The core logic for scheduling shipments and simulating inventory levels resides in a separate <strong
                data-tooltip="A script running in the background, separate from the main browser thread, to perform computationally intensive tasks without freezing the user interface.">Web
                Worker</strong>. This prevents complex calculations from blocking the user interface.
        </p>

        <h4>Shipment Scheduling</h4>
        <p>
            Before the daily simulation runs, an optimal shipment schedule is determined using <strong
                data-tooltip="Mixed Integer Linear Programming: A mathematical optimization technique used to find the best outcome (e.g., minimum cost, maximum profit) in a model where some variables must be integers (often binary 0/1).">Mixed
                Integer Linear Programming (MILP)</strong>.
        </p>
        <p>
            The goal is to **minimize the peak daily shipment volume (`Z`)** across the entire year, subject to meeting
            the required shipment frequency for each city. This levels the workload on the warehouse and transportation
            system.
        </p>
        <ul>
            <li>
                <strong>Variables:</strong>
                <ul>
                    <li><code>Z</code>: A continuous variable representing the max number of units shipped on any
                        single day (the value to be minimized).</li>
                    <li><code>x<sub>city, startDay</sub></code>: A binary (0 or 1) variable for each city and each
                        potential starting day (from 1 to <code>freq</code>). It's 1 if the city's schedule *starts* on
                        that day, and 0 otherwise.</li>
                </ul>
            </li>
            <li>
                <strong>Constraints:</strong>
                <ol>
                    <li>
                        <strong>Start Day Selection:</strong> Each city must choose exactly one starting day from its
                        allowed options.
                        \[ \sum_{\text{startDay}=1}^{\text{freq}} x_{\text{city, startDay}} = 1
                        \quad
                        (\forall \text{ city}) \]
                    </li>
                    <li>
                        <strong>Daily Load Limit:</strong> For every day <code>t</code>, the total quantity of units
                        scheduled (based on the chosen start days and frequencies) must not exceed <code>Z</code>.
                        \[ \sum_{\text{city}}
                        \sum_{\substack{\text{chosen startDay } t}}
                        (\text{Quantity}_{\text{city}} \times x_{\text{city, startDay}}) \le Z \quad (\forall \text{ day
                        } t) \]
                    </li>
                </ol>
            </li>
        </ul>
        <p>
            This MILP model is formulated as a string and solved using the <strong
                data-tooltip="High Performance Optimization Software: An open-source solver for linear programming (LP), mixed-integer programming (MIP), and quadratic programming (QP) problems.">HiGHS</strong>
            solver via WebAssembly. If the solver fails, a simple heuristic (starting each city on day 1) is used as a
            fallback.
        </p>

        <h4>Daily Inventory Simulation</h4>
        <p>
            This function simulates the inventory flow day-by-day for a full year (365 days). It executes in multiple
            passes to meet demand while minimizing inventory and exception costs.
        </p>
        <h4>Pass 1: Forward Simulation (Meet All Demand)</h4>
        <p>
            The first pass is a "safety" simulation that guarantees all demand is met by building inventory and using
            overtime if necessary. It follows a 3-Tier logic:
        </p>
        <ol>
            <li>
                <strong>Target Production (Smoothing):</strong> On any given working day, the line's default
                action is to produce the "desired" amount, defined by the daily demand (e.g., 180 units). 
                This builds a smooth, predictable inventory level, preventing the massive overproduction of building to max capacity every day.
            </li>
            <li>
                <strong>Flex-to-Max (No Cost):</strong> After Tier 1 production, the system
                checks for shortfalls for that day's scheduled shipments. If a shortfall exists (e.g., a lumpy shipment
                of 200 arrives but only 180 were built), the line will "flex" its production *on the current day* up to
                its Max Standard Production (e.g., 215) to cover the difference. This step does **not** incur
                any exception cost.
            </li>
            <li>
                <strong>Reactive OT (Costly):</strong> If the shortfall *still* exists after
                Tier 2 (e.g., the shipment was 300 units), the simulation looks *backward* to previous working days. It
                adds costly overtime to those days, increasing their Operational Hours and Production,
                until the shortfall is met. This generates an Exception Cost and `Accumulated Extra Hours`.
            </li>
        </ol>
        <p> This pass also handles first-week shipment deferrals and logs critical "Demand Conflict" errors
            if a shipment is impossible to meet. The shipment details from this "safe" pass
            are saved as the mandatory shipment schedule for the optimization passes.
        </p>

        <h4>Pass 2: Optimization (Remove Unnecessary Inventory)</h4>
        <p> After Pass 1, the simulation has a schedule that works but may contain significant "slack"
            (excess inventory) and "overage" (production from OT). Step 7 runs a two-stage optimization to remove this
            waste.
        </p>
        <ol>
            <li>
                <strong>Forward Pass: Slack Removal:</strong>
                <ul>
                    <li>First, the simulation finds the "cushion" Minimum Safe Inventory Level,
                        which is the true minimum inventory level required at any point during the year to meet the
                        shipment schedule from Pass 1.</li>
                    <li>It then iterates *forward* from Day 0. On any "standard" (Tier 1) production
                        day, it runs a "what-if" check to see if removing that *entire*
                        day's production would *ever* cause the inventory to drop below the `minSafeInventory` cushion.
                    </li>
                    <li>If the check passes (it is safe), the day's production is permanently set to
                        0, it's marked as a `Reduction Day`, and the inventory for the rest of the year is
                        recalculated.</li>
                    <li>This process removes slack inventory as early as possible, maximizing
                        holding cost savings.</li>
                </ul>
            </li>
            <li>
                <strong>Backward Pass: OT Offset:</strong>
                <ul>
                    <li>After slack is removed, the simulation iterates *backward* to balance out the annual demand and budget.
                    </li>
                    <li>It looks for any *remaining* standard production days (as total hours) that were not removed
                    </li>
                    <li>It runs another check to see if removing this day is safe (checking against the final `Target End Inventory` of 0).</li>
                    <li>If safe, the day is removed and marked as a `Reduction Day` to offset `Accumulated Extra Hours`</li>
                </ul>
            </li>
        </ol>

        <h4>Pass 3: Final Recalculation</h4>
        <p> Finally, the simulation does one last, fast pass to recalculate all Holding Cost
            values based on the new, optimized `Inventory End` levels for each day. The result,
            which now meets all demand with the minimum possible inventory and cost, is returned to the main application.
        </p>

        <h3>Quality Yield & Stress Model</h3>
        <p>
            Manufacturing quality is treated as a dynamic variable derived from system stress. The simulation calculates
            a <strong
                data-tooltip="The percentage of products produced that meet quality standards without requiring rework.">First
                Pass Yield (FPY)</strong> starting at 100% and subtracting penalties based on four distinct stress
            vectors.
        </p>
        \[ \text{Total Stress} = (0.4 \times \text{Process Stress}) + (0.2 \times \text{Conveyor Stress}) + (0.2 \times
        \text{Wage Stress}) + (0.2 \times \text{Overtime Stress}) \]
        \[ \text{Quality Yield} = 1.0 - \text{Total Stress} \]

        <h4>1. Process Capability Stress (Variability vs. Slack)</h4>
        <p>
            This stress models the probability that a station cannot complete its work within the allotted time, causing a
            line stop or a rushed (defective) unit. This is not a static failure rate; it is a dynamic interaction between three variables:
        </p>
        <ul>
            <li><strong>Task Variation (<strong
                        data-tooltip="Coefficient of Variation: Standard Deviation / Mean. Represents the inherent instability of the process.">CV</strong>):</strong>
                The width of the bell curve. A higher CV flattens the curve, pushing the "tail" of long task times out.
            </li>
            <li><strong>Slack Time:</strong> The safety buffer. Calculated as \( \text{Takt Time} -
                \text{Station Cycle Time} \).</li>
            <li><strong>Bayesian Recovery:</strong> The model accounts for the fact that a single cycle overrun does not
                guarantee a failure. If the <em>next</em> unit is produced faster than the average, it can absorb the
                delay, based on Bayesian probabilities of the MSSA Production Sequence</li>
        </ul>
        <p>
            The stress is calculated as the <strong>Tail Probability</strong> (area under the Log-Normal curve beyond Takt Time)
            weighted by the <strong>Conditional Probability</strong> that the subsequent cycle lacks sufficient slack to
            recover the specific time lost.
        </p>

        <div style="text-align: center; margin: 2rem 0;">
            <svg width="600" height="300" viewBox="0 0 600 300" style="background: #fff; border: 1px solid #ddd;">
                [attachment_0](attachment)
                <defs>
                    <linearGradient id="gradSafe" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:#4CAF50;stop-opacity:0.1" />
                        <stop offset="100%" style="stop-color:#4CAF50;stop-opacity:0.4" />
                    </linearGradient>
                    <pattern id="diagonalHatch" patternUnits="userSpaceOnUse" width="4" height="4">
                        <path d="M-1,1 l2,-2 M0,4 l4,-4 M3,5 l2,-2" style="stroke:#D32F2F; stroke-width:1" />
                    </pattern>
                </defs>
                <line x1="50" y1="260" x2="550" y2="260" stroke="#333" stroke-width="2" />
                <line x1="50" y1="260" x2="50" y2="40" stroke="#333" stroke-width="2" />   <text x="300" y="290"
                    text-anchor="middle" font-family="sans-serif" font-size="12">Task Duration (Time)</text>
                <path d="M50,260 Q100,260 150,100 Q200,40 300,150 T550,260" fill="none" stroke="#333"
                    stroke-width="2" />
                <line x1="240" y1="40" x2="240" y2="260" stroke="#2196F3" stroke-width="2" stroke-dasharray="5,5" />
                <text x="240" y="30" fill="#2196F3" text-anchor="middle" font-family="sans-serif" font-size="11"
                    font-weight="bold">Mean Cycle Time</text>
                <line x1="400" y1="40" x2="400" y2="260" stroke="#D32F2F" stroke-width="3" />
                <text x="400" y="30" fill="#D32F2F" text-anchor="middle" font-family="sans-serif" font-size="11"
                    font-weight="bold">Takt Time Limit</text>
                <path d="M240,100 L400,100" stroke="#4CAF50" stroke-width="2" marker-end="url(#arrow)"
                    marker-start="url(#arrow)" />
                <rect x="270" y="85" width="100" height="30" fill="white" opacity="0.9" />
                <text x="320" y="103" fill="#4CAF50" text-anchor="middle" font-family="sans-serif" font-weight="bold"
                    font-size="12">SLACK (Buffer)</text>
                <path d="M400,230 Q450,250 550,260 L400,260 Z" fill="url(#diagonalHatch)" opacity="0.5" />
                <text x="475" y="220" fill="#D32F2F" text-anchor="middle" font-family="sans-serif" font-size="11"
                    font-weight="bold">Overrun Risk</text>
                <text x="50" y="40" font-family="sans-serif" font-size="11" fill="#555">
                    <tspan x="60" dy="1.2em">High CV widens curve,</tspan>
                    <tspan x="60" dy="1.2em">increasing the overlap</tspan>
                    <tspan x="60" dy="1.2em">past Takt Time.</tspan>
                </text>
            </svg>
            <p style="font-style: italic; font-size: 0.9rem; color: #666; text-align: center;">
                Visualizing Stress: The intersection of Variability (Curve) and Constraints (Takt Time).
            </p>
        </div>

        <<h4>2. Conveyor Speed Stress (Speed vs. Variability)</h4>
            <p>
                Working on a moving line introduces physical stress (vibration, tracking difficulty).
                However, this stress is heavily compounded by process variability (<strong
                    data-tooltip="Coefficient of Variation. A high CV means task times are inconsistent.">CV</strong>).
            </p>
            <p>
                If a worker has high variability, they need a stationary target to recover from "slow" cycles. A moving conveyor
                removes that recovery buffer. Therefore, the model <strong>derates</strong> the "Safe Speed Limit" based on the CV.
            </p>
            <ul>
                <li><strong>Base Limit:</strong> 15 ft/min is the maximum safe speed for a perfectly consistent process
                    (CV = 0).</li>
                <li><strong>Derated Limit:</strong> As CV increases, the safe speed drops.
                    \[ \text{Effective Safe Speed} = 15 \text{ ft/min} \times (1.0 - \text{CV}) \]
                </li>
                <li><strong>Stress Formula:</strong> Stress grows exponentially as the actual conveyor speed approaches
                    this reduced limit.
                    \[ \text{Speed Stress} = \left( \frac{\text{Actual Speed}}{\text{Effective Safe Speed}} \right)^2
                    \times 0.05 \]
                </li>
            </ul>
            <p><em>Example: If CV is 20%, the Safe Speed drops to 12 ft/min. Running at 15 ft/min would essentially ensure defects.</em></p>

            <h4>3. Local Wage Stress (Location Tab)</h4>
            <p>
                The quality of the workforce is modeled as a function of the wages paid relative to the local market conditions.
                This captures how underpaying employees will increase their stress, engagement, turnover, and starting skill level.
                The system uses adaptive 3rd-party APIs to fetch the **Median Household Income** for the specific Census Block
                of the factory's optimal location (lat/lon).
            </p>
            <p>To ensure reliability between APIs, the system employs an <strong>Adaptive "Shotgun-to-Race" Strategy</strong> for fetching wage data:</p>
            <ul>
                <li><strong>Cold Start (Discovery):</strong> On the first request, the system fires <em>all</em> combinations of proxies (Direct, CorsProxy, AllOrigins) and data granularities (Census Tract, County) simultaneously. 
                    It waits for all to settle to build a complete reliability profile for the user's network environment.
                </li>
                <li><strong>Scoring Algorithm:</strong> Strategies are ranked dynamically based on:
                    <ul>
                        <li><strong>Reliability:</strong> Heavy weighting for successful returns.</li>
                        <li><strong>Speed:</strong> Moderate weighting for lower latency.</li>
                        <li><strong>Precision:</strong> Slight bonus for Tract-level data over County-level.</li>
                    </ul>
                </li>
                <li><strong>Warm State (Optimization):</strong> Subsequent requests select the <strong>Top 2</strong> ranked strategies and race them in parallel. 
                    An <code>AbortController</code> is used to immediately terminate the slower request once the winner returns, minimizing bandwidth usage.
                </li>
            </ul>
            <p>This leads to a more robust system of returning Median Household Income which improves with usage.  Once the Income is returned, the Wage Stress is calculated by:</p>
            <ul>
                <li><strong>Step 1:</strong> Convert Median Household Income to an hourly rate (assuming a full-time 2080 hours/year).
                </li>
                <li><strong>Step 2:</strong> Compare the user-set Labor Cost to this local median.</li>
                <li><strong>Step 3:</strong> Calculate Stress. If the user pays <em>above</em> the median, stress is 0.
                    If they pay <em>below</em> 60% of the median, stress is maximized (1.0). Between these points, it scales linearly.
                </li>
            </ul>
            \[ \text{Wage Stress} = \begin{cases}
            0 & \text{if } \text{Pay} \ge \text{Median} \\
            \frac{\text{Median} - \text{Pay}}{\text{Median} - (0.6 \times \text{Median})} & \text{if } \text{Median} \gt
            \text{Pay} \gt (0.6 \times \text{Median}) \\
            1 & \text{if } \text{Pay} \le (0.6 \times \text{Median}) \\
            \end{cases} \]

            <h4>4. Exception Stress (Sigmoid Function)</h4>
            <p>
                High utilization (overtime, rushing) causes defects. The simulation tracks the percentage of days
                that required exceptions (Overtime). This ratio is fed into a <strong
                    data-tooltip="An 'S'-shaped curve defined by the logistic function. Used here to model a threshold effect where low overtime has little impact, but high overtime causes quality to collapse rapidly.">Sigmoid
                    Function</strong>.
            </p>
            <p>
                The Sigmoid creates a realistic threshold effect: a small amount of overtime has negligible impact on quality,
                but once a tipping point (around 20% overtime days) is reached, the stress factor skyrockets, reflecting
                worker burnout and systemic errors.
            </p>

            <div style="text-align: center; margin: 2rem 0;">
                <svg width="500" height="250" viewBox="0 0 500 250" style="background: #fff; border: 1px solid #ddd;">
                    <line x1="50" y1="220" x2="450" y2="220" stroke="#333" stroke-width="2" />
                    <line x1="50" y1="220" x2="50" y2="20" stroke="#333" stroke-width="2" />
                    <text x="250" y="245" text-anchor="middle" font-family="sans-serif" font-size="0.9rem">% Days with
                        Overtime</text>
                    <text x="20" y="120" text-anchor="middle" transform="rotate(-90, 20, 120)" font-family="sans-serif"
                        font-size="0.9rem">Stress Factor (Quality Loss)</text>
                    <path d="M50,215 C200,215 200,20 400,20" fill="none" stroke="#3F51B5" stroke-width="4" />
                    <circle cx="50" cy="215" r="4" fill="#3F51B5" />
                    <circle cx="225" cy="97" r="5" fill="#F44336" />
                    <circle cx="400" cy="20" r="4" fill="#3F51B5" />
                    <line x1="225" y1="97" x2="225" y2="220" stroke="#F44336" stroke-width="3" stroke-dasharray="4,4" />
                    <text x="230" y="210" fill="#666" font-family="sans-serif" font-size="1.1rem">Tipping Point
                        (~20%)</text>
                    <text x="100" y="120" fill="#4CAF50" font-family="sans-serif" font-size="1.1rem">Safe Zone</text>
                    <text x="320" y="80" fill="#F44336" font-family="sans-serif" font-size="1.1rem">Burnout Zone</text>
                </svg>
                <p style="font-style: italic; font-size: 0.9rem; color: #666;">
                    Sigmoid Function: Overtime vs. Quality Stress
                </p>
            </div>

            <h3>Financial Impact: Cost of Poor Quality (CoPQ)</h3>
            <p>
                The calculated Quality Yield directly impacts the bottom line through the <strong  
                    data-tooltip="Cost of Poor Quality: The financial loss generated by defective products. In this simulation, it is modeled purely as Rework Cost.">CoPQ</strong> metric.
            </p>
            <ol>
                <li><strong>Failed Units:</strong> The system calculates how many units failed quality checks based on the yield.
                    \[ \text{Failed Units} = \text{Total Production} \times (1.0 - \text{Quality Yield}) \]
                </li>
                <li><strong>Rework Cost Calculation:</strong> Failed units are not scrapped; they are reworked.
                    Each model type (Super, Ultra, Mega) has a specific Rework Cost input in the Finance Tab.
                    \[ \text{CoPQ} = \sum (\text{Failed Units}_{\text{model}} \times \text{Rework Cost}_{\text{model}})
                    \]
                </li>
                <li><strong>Profit Reduction:</strong> CoPQ is subtracted directly from Revenue, effectively acting as
                    an additional variable cost that reduces the Gross Margin.
                </li>
            </ol>
    </div>
</body>

</html>